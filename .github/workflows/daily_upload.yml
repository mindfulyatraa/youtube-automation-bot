name: Daily YouTube Upload

on:
  schedule:
    # IST is UTC+5:30
    # 09:00 AM IST = 03:30 UTC
    # 08:00 PM IST = 14:30 UTC
    - cron: '30 3 * * *'
    - cron: '30 14 * * *'
  workflow_dispatch:  # Allows manual run from GitHub UI

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Important for pushing changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Dependencies (FFmpeg & ImageMagick)
        run: sudo apt-get update && sudo apt-get install -y ffmpeg imagemagick

      - name: Fix ImageMagick Policy
        run: |
          # Enable PDF/Thinker for TextClip (Crucial for MoviePy)
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Secrets Files
        run: |
          echo '${{ secrets.CLIENT_SECRETS_JSON }}' > client_secrets.json
          echo '${{ secrets.TOKEN_JSON }}' > token.json

      - name: Run Upload Script
        run: python youtube_automation.py --automated-run-once
        env:
          PYTHONIOENCODING: utf-8

      - name: Commit and Push History
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add upload_history.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update upload history [skip ci]" && git push)
